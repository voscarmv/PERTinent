<h1>Work breakdown structure</h1>

<% root_node = @rows.shift[0] %>
<div class="d-flex flex-wrap align-content-between justify-content-around m-5">
  <div class="rounded bg-primary opacity-90 p-3 mt-5 mb-5 ml-1 mr-1 node" id="n_<%= root_node.id %>">
    <h2><%= root_node.name %></h2>
    <p><%= link_to 'Add subtask', new_node_path(link: {parent_node: root_node.id}, node: {project_id: @project.id}), class: "btn btn-primary btn-sm text-white"%></p>
  </div>
</div>

<% @rows.each { |r| %>
  <div class="d-flex flex-wrap align-content-between justify-content-around m-5">
  <% r.each { |node| %>
    <div class="rounded bg-success opacity-90 p-3 mt-5 mb-5 ml-1 mr-1 node" id="n_<%= node.id %>">
      <h2><%= node.name %></h2>
      <p><%= link_to 'Add subtask', new_node_path(link: {parent_node: node.id}, node: {project_id: @project.id}), class: "btn btn-primary btn-sm text-white"%></p>
      <p><%= link_to 'Connect to task', new_link_path(link: {from_id: node.id, project_id: @project.id}), class: "btn btn-primary btn-sm text-white"%></p>
      <% unless node.from_nodes.exists? %>
        <p><%= link_to 'Delete this node', node, method: :delete, class: "btn btn-danger btn-sm text-white" %></p>
      <% end %>
      <% if node.from_links.or(node.to_links).exists? %>
      <ul>
        <% if node.to_links.count > 1 %>
          <% node.to_links.each { |to_link| %>
            <li><%= link_to "Delete to_link #{to_link.id}", to_link, method: :delete, class: "btn btn-danger btn-sm text-white" %></li>
          <% } %>
        <% end %>
        <% node.from_links.each { |from_link| %>
          <% if from_link.from_node.to_links.count > 1 %>
            <li><%= link_to "Delete from_link #{from_link.id}", from_link, method: :delete, class: "btn btn-danger btn-sm text-white" %></li>
          <% end %>
        <% } %>
      </ul>
      <% end %>
    </div>
  <% } %>
  </div>
<!--  <div class="d-flex m-5"></div>
  <div class="d-flex m-5"></div>
  -->
<% } %>

<svg xmlns="http://www.w3.org/2020/svg" id="svg_bg" style="width:100%; position: absolute; top: 0; z-index: -1;">
  <defs>
    <marker id="arrowheadfuchsia" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" stroke="fuchsia" fill="fuchsia">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>
    <marker id="arrowheadcyan" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" stroke="cyan" fill="cyan">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>
    <marker id="arrowheadblack" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" stroke="black" fill="black">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>
  </defs>
  <g fill="none" stroke="black" stroke-width="4" marker-end="url(#arrowheadblack)">
    
    <% (0..@edges.length).each { |i| %>
    <path id="e_<%= i %>"/>
    <% } %>
  </g>
</svg>

<script>
  const edges = <%= @edges.to_s %>;
  const nodes = <%= @vertices.to_s %>
</script>

<%= javascript_pack_tag 'arrows' %>

<p id="notice"><%= notice %></p>

<p>
  <strong>Name:</strong>
  <%= @project.name %>
</p>

<p>
  <strong>Description:</strong>
  <%= @project.description %>
</p>

<p>
  <strong>User:</strong>
  <%= @project.user_id %>
</p>

<%= link_to 'Edit', edit_project_path(@project) %> |
<%= link_to 'Back', projects_path %>
